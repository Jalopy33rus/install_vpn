#!/bin/bash

set -e

# === ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ Ð¿Ð¾Ñ€Ñ‚Ð¾Ð² ===
WG_PORT=51820
SS_PORT=101

# === Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° UFW Ð¸ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° ===
echo "ðŸ” ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° UFW..."

if ! command -v ufw &> /dev/null; then
  echo "ðŸ“¦ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° ufw..."
  apt update && apt install -y ufw
fi

ufw allow 22/tcp
ufw allow ${WG_PORT}/udp
ufw allow ${SS_PORT}/tcp
ufw allow ${SS_PORT}/udp

ufw --force enable

# === Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸ ===
mkdir -p ~/docker-vpn && cd ~/docker-vpn

# === WireGuard Docker ===
echo "âš™ï¸ ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° WireGuard Ð² Docker..."

mkdir -p wireguard && cd wireguard

cat > docker-compose.yml <<EOF
version: '3.8'

services:
  wireguard:
    image: linuxserver/wireguard
    container_name: wireguard
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Etc/UTC
      - SERVERPORT=${WG_PORT}
      - PEERS=client1
      - ALLOWEDIPS=0.0.0.0/0
    volumes:
      - ./config:/config
      - /lib/modules:/lib/modules
    ports:
      - "${WG_PORT}:${WG_PORT}/udp"
    sysctls:
      - net.ipv4.conf.all.src_valid_mark=1
    restart: unless-stopped
EOF

cd ..

# === Shadowsocks Docker ===
echo "âš™ï¸ ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Shadowsocks Ð² Docker..."

mkdir -p shadowsocks && cd shadowsocks

cat > docker-compose.yml <<EOF
version: '3'

services:
  shadowsocks:
    image: shadowsocks/shadowsocks-libev
    container_name: shadowsocks
    ports:
      - "${SS_PORT}:${SS_PORT}/tcp"
      - "${SS_PORT}:${SS_PORT}/udp"
    environment:
      - SERVER_ADDR=0.0.0.0
      - SERVER_PORT=${SS_PORT}
      - PASSWORD=Oqdj2VIWQJ91
      - METHOD=chacha20-ietf-poly1305
    restart: unless-stopped
EOF

cd ..

# === Ð—Ð°Ð¿ÑƒÑÐº Ð²ÑÐµÑ… ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð¾Ð² ===
echo "ðŸš€ Ð—Ð°Ð¿ÑƒÑÐº WireGuard Ð¸ Shadowsocks..."
docker compose -f wireguard/docker-compose.yml up -d
docker compose -f shadowsocks/docker-compose.yml up -d

echo -e "\nâœ… Ð“Ð¾Ñ‚Ð¾Ð²Ð¾!"
echo "WireGuard Ð¿Ð¾Ñ€Ñ‚: ${WG_PORT}/udp"
echo "Shadowsocks Ð¿Ð¾Ñ€Ñ‚: ${SS_PORT}/tcp Ð¸ udp"
